# Workflow(Action) åç¨±
name: CI-Testing

# Actions Log çš„æ¨™é¡Œåç¨±
run-name: "[CI-Testing] ${{ github.event.pull_request.title || github.ref }}"

# åŒå€‹ Concurrency Group å¦‚æœæœ‰æ–°çš„ Job æœƒå–æ¶ˆæ­£åœ¨è·‘çš„
# ä¾‹å¦‚ Push Commit è§¸ç™¼çš„ä»»å‹™é‚„æ²’åŸ·è¡Œå°±åˆ Push Commit æ™‚ï¼Œæœƒå–æ¶ˆå‰ä¸€å€‹ä»»å‹™
concurrency:
  group: ${{ github.workflow }}-${{ github.event_name }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

# è§¸ç™¼äº‹ä»¶
on:
  # PR äº‹ä»¶
  pull_request:
    # PR - é–‹å•Ÿã€é‡é–‹ã€æœ‰æ–° Push Commit æ™‚
    types: [opened, synchronize, reopened]
  # æ‰‹å‹•è¡¨å–®è§¸ç™¼
  workflow_dispatch:
    # è¡¨å–® Inputs æ¬„ä½
    inputs:
      # åŸ·è¡Œçš„ Test Fastlane Lane
      TEST_LANE:
        description: 'Test Lane'
        default: 'run_unit_tests'
        type: choice
        options:
          - run_unit_tests
          - run_all_tests
  # å…¶ä»– Workflow å‘¼å«æ­¤ Workflow è§¸ç™¼
  # Nightly Build æœƒå‘¼å«ä½¿ç”¨
  workflow_call:
    # è¡¨å–® Inputs æ¬„ä½
    inputs:
      # åŸ·è¡Œçš„ Test Fastlane Lane
      TEST_LANE:
        description: 'Test Lane'
        default: 'run_unit_tests'
        # workflow_call inputs ä¸æ”¯æ´ choice
        type: string
      BRANCH:
        description: 'Branch'
        type: string
  
# Job å·¥ä½œé …ç›®
# Job æœƒä¸¦ç™¼åŸ·è¡Œ
jobs:
  # Job ID
  testing:
    # Job åç¨± (å¯çœç•¥ï¼Œæœ‰è¨­å®šåœ¨ Log é¡¯ç¤ºæ¯”è¼ƒå¥½è®€)
    name: Testing
    
    # Runner Label - ä½¿ç”¨ GitHub Hosted Runner macos-15 ä¾†åŸ·è¡Œå·¥ä½œ
    # è«‹æ³¨æ„ï¼šå› ç‚ºæ­¤å°ˆæ¡ˆæ˜¯ Public Repo å¯ä»¥ç„¡é™å…è²»ä½¿ç”¨
    # è«‹æ³¨æ„ï¼šå› ç‚ºæ­¤å°ˆæ¡ˆæ˜¯ Public Repo å¯ä»¥ç„¡é™å…è²»ä½¿ç”¨
    # è«‹æ³¨æ„ï¼šå› ç‚ºæ­¤å°ˆæ¡ˆæ˜¯ Public Repo å¯ä»¥ç„¡é™å…è²»ä½¿ç”¨
    # å¦‚æœæ˜¯ Private Repo éœ€è¦æŒ‰è¨ˆé‡æ”¶è²»ï¼ŒmacOS æ©Ÿå™¨æ˜¯æœ€è²´çš„(10å€)ï¼Œå¯èƒ½è·‘ 10 æ¬¡å°±é”åˆ° 2,000 åˆ†é˜å…è²»ä¸Šé™
    # å»ºè­°ä½¿ç”¨ self-hosted Runner
    runs-on: macos-15

    # è¨­å®šæœ€é•· Timeout æ™‚é–“ï¼Œé˜²æ­¢ç•°å¸¸æƒ…æ³ç™¼ç”Ÿæ™‚ç„¡æ­¢ç›¡çš„ç­‰å¾…
    timeout-minutes: 30

    # use zsh
    # å¯çœç•¥ï¼Œåªæ˜¯æˆ‘ç¿’æ…£ç”¨ zshï¼Œé è¨­æ˜¯ bash
    defaults:
      run:
        shell: zsh {0}
          
    # å·¥ä½œæ­¥é©Ÿ
    # å·¥ä½œæ­¥é©Ÿæœƒç…§é †åºåŸ·è¡Œ  
    steps:
      # git clone ç•¶å‰å°ˆæ¡ˆ & checkout åˆ°åŸ·è¡Œçš„åˆ†æ”¯
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          # Git Large File Storageï¼Œæˆ‘å€‘çš„æ¸¬è©¦ç’°å¢ƒç”¨ä¸åˆ°
          # default: false
          lfs: false
          
          # å¦‚æœæœ‰æŒ‡å®šå‰‡ Checkout æŒ‡å®šåˆ†æ”¯ï¼Œæ²’æœ‰å‰‡ä½¿ç”¨é è¨­(ç•¶å‰åˆ†æ”¯)
          # å›  on: schedule äº‹ä»¶åªèƒ½åœ¨ main ä¸»åˆ†æ”¯åŸ·è¡Œï¼Œå› æ­¤æƒ³åš Nightly Build ä¹‹é¡çš„å·¥ä½œå°±éœ€è¦æŒ‡å®šåˆ†æ”¯
          # e.g. on: schedule -> main åˆ†æ”¯ï¼ŒNightly Build master åˆ†æ”¯
          ref: ${{ github.event.inputs.BRANCH || '' }}

      # ========== Env Setup Steps ==========
      
      # è®€å–å°ˆæ¡ˆæŒ‡å®šçš„ XCode ç‰ˆæœ¬
      # åœ¨å¾ŒçºŒä¹‹ä¸­ï¼Œæˆ‘å€‘è‡ªå·±æ‰‹å‹•æŒ‡å®šä½¿ç”¨çš„ XCode_x.x.x.app
      # è€Œä¸ä½¿ç”¨ xcversionï¼Œå› ç‚º xcversion å·²ç¶“ sunset ä¸ç©©å®šã€‚ 
      - name: Read .xcode-version
        id: read_xcode_version
        run: |
          XCODE_VERSION=$(cat .xcode-version)
          echo "XCODE_VERSION: ${XCODE_VERSION}"
          echo "xcode_version=${XCODE_VERSION}" >> $GITHUB_OUTPUT

          # ä¹Ÿå¯ä»¥ç›´æ¥åœ¨é€™æŒ‡å®šå…¨åŸŸ XCode ç‰ˆæœ¬ï¼Œé€™æ¨£å°±ä¸ç”¨åœ¨å¾ŒçºŒæ­¥é©ŸæŒ‡å®š DEVELOPER_DIR
          # ä½†æ­¤æŒ‡ä»¤éœ€è¦ sudoer æ¬Šé™ï¼Œå¦‚æœæ˜¯ self-hosted runner å°±è¦ç¢ºå®š runner åŸ·è¡Œç’°å¢ƒæœ‰ sudo æ¬Šé™
          # sudo xcode-select -s "/Applications/Xcode_${XCODE_VERSION}.app/Contents/Developer"

      # è®€å–å°ˆæ¡ˆæŒ‡å®šçš„ Ruby ç‰ˆæœ¬
      - name: Read .ruby-version
        id: read_ruby_version
        run: |
          RUBY_VERSION=$(cat .ruby-version)
          echo "RUBY_VERSION: ${RUBY_VERSION}"
          echo "ruby_version=${RUBY_VERSION}" >> $GITHUB_OUTPUT

      # å®‰è£æˆ–è¨­å®š Runner Ruby ç‰ˆæœ¬æˆå°ˆæ¡ˆæŒ‡å®šç‰ˆæœ¬
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "${{ steps.read_ruby_version.outputs.ruby_version }}"

      # å¯è¨­å¯ä¸è¨­ï¼ŒåŸå› æ˜¯ä¹‹å‰åœ¨ self-hosted èµ·å¤šå€‹ runner è·‘ CI/CD å› ç‚º cocoapods repos æ˜¯å…±ç”¨ç›®éŒ„
      # è§£æ±ºçš„å•é¡Œæ˜¯ï¼šæœ‰å¾ˆå°çš„æ©Ÿç‡æœƒå‡ºç¾åœ¨åŒæ™‚ pod install æ™‚æ‹‰ cocoapods repos å‡ºç¾è¡çª(å› ç‚ºé è¨­éƒ½æ˜¯ç”¨) $HOME/.cocoapods/
      # GitHub Hosted Runner å‰‡ä¸éœ€æ­¤è¨­å®š
      # - name: Change Cocoapods Repos Folder
      #   if: contains(runner.labels, 'self-hosted')
      #   run: |
      #     # æ¯å€‹ Runner ç”¨è‡ªå·±çš„ .cocoapods è³‡æ–™å¤¾ï¼Œé˜²æ­¢è³‡æºè¡çª
      #     mkdir -p "$HOME/.cocoapods-${{ env.RUNNER_NAME }}/"
      #     export CP_HOME_DIR="$HOME/.cocoapods-${{ env.RUNNER_NAME }}"
      #     rm -f "$HOME/.cocoapods-${{ env.RUNNER_NAME }}/repos/cocoapods/.git/index.lock"

      # ========== Cache Setting Steps ==========
      # è«‹æ³¨æ„ï¼Œå°±ç®—æ˜¯ self-hostedï¼ŒCache ç›®å‰ä¹Ÿæ˜¯ Cloud Cache æœƒè¨ˆç®—ç”¨é‡
      # è¦å‰‡ï¼š7 å¤©æœª hit è‡ªå‹•åˆªé™¤ã€å–®å€‹ Cache ä¸Šé™ 10 GBã€Action æˆåŠŸæ‰æœƒ Cache
      # Public Repo: å…è²»ç„¡é™åˆ¶
      # Private Repo: 5 GB èµ·
      # Self-hosted å¯ä»¥è‡ªå·±ç”¨ shell script æ’°å¯« Cache & Restore ç­–ç•¥æˆ–ä½¿ç”¨å…¶ä»–å·¥å…·å”åŠ©
      
      # Bundle Cache (Gemfile)
      # å°æ‡‰ Makefile ä¸­æˆ‘å€‘æŒ‡å®šäº† Bundle  å®‰è£è·¯å¾‘ ./vendor ä¸‹
      - name: Cache Bundle
        uses: actions/cache@v3
        with:
          path: |
            ./vendor
          key: ${{ runner.os }}-bundle-${{ hashFiles('Gemfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-bundle-

      # CocoaPods Cache (Podfile)
      # é»˜èªå°±æ˜¯ å°ˆæ¡ˆ/Pods ä¸‹
      - name: Cache CocoaPods
        uses: actions/cache@v3
        with:
          path: |
            ./Product/Pods
          key: ${{ runner.os }}-cocoapods-${{ hashFiles('Product/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-cocoapods-

      # Mint cache
      # å°æ‡‰ Makefile ä¸­æˆ‘å€‘æŒ‡å®šçš„ Mint å®‰è£è·¯å¾‘ ./mint ä¸‹
      - name: Cache Mint
        uses: actions/cache@v3
        with:
          path: ./mint
          key: ${{ runner.os }}-mint-${{ hashFiles('Mintfile') }}
          restore-keys: |
            ${{ runner.os }}-mint-

      # ====================

      # å°ˆæ¡ˆ Setup & ä¾è³´å®‰è£
      - name: Setup & Install Dependency
        run: |
          # åŸ·è¡Œ Makefile ä¸­å°è£çš„ Setup æŒ‡ä»¤ï¼Œå°æ‡‰æˆæŒ‡ä»¤å¤§æ¦‚æ˜¯ï¼š
          # brew install mint
          # bundle config set path 'vendor/bundle'
          # bundle install
          # mint bootstrap
          # ...
          # ç­‰ç­‰ setup æŒ‡ä»¤
          make setup

          # åŸ·è¡Œ Makefile ä¸­å°è£çš„ Install æŒ‡ä»¤ï¼Œå°æ‡‰æˆæŒ‡ä»¤å¤§æ¦‚æ˜¯ï¼š
          # mint run yonaskolb/XcodeGen --quiet
          # bundle exec pod install
          # ...
          # ç­‰ç­‰ install æŒ‡ä»¤
          make install

      # åŸ·è¡Œ Fastlane Unit æ¸¬è©¦ Lane
      - name: Run Tests
        id: testing
        # æŒ‡å®šå·¥ä½œç›®éŒ„ï¼Œé€™æ¨£å¾ŒçºŒæŒ‡ä»¤å°±ä¸ç”¨åœ¨ç‰¹åˆ¥ cd ./Product/
        working-directory: ./Product/
        env:
          # æ¸¬è©¦è¨ˆåŠƒï¼Œå…¨è·‘é‚„æ˜¯åªè·‘å–®å…ƒæ¸¬è©¦
          # å¦‚ç‚ºé–‹ PR è§¸ç™¼å‰‡ä½¿ç”¨ run_unit_testsï¼Œå¦å‰‡çœ‹ inputs.TEST_LANE çš„å€¼ï¼Œé è¨­å€¼ run_all_tests
          TEST_LANE: ${{ github.event_name == 'pull_request' && 'run_unit_tests' || github.event.inputs.TEST_LANE || 'run_all_tests' }}
          
          # æŒ‡å®šé€™å€‹ Job è¦ä½¿ç”¨ XCode_x.x.x æŒ‡å®šçš„ç‰ˆæœ¬åŸ·è¡Œ
          DEVELOPER_DIR: "/Applications/Xcode_${{ steps.read_xcode_version.outputs.xcode_version }}.app/Contents/Developer"
          
          # Repo -> Settings -> Actions secrets and variables -> variables
          # ä½¿ç”¨çš„æ¨¡æ“¬å™¨åç¨±
          SIMULATOR_NAME: ${{ vars.SIMULATOR_NAME }}
          # æ¨¡æ“¬å™¨çš„ iOS ç‰ˆæœ¬
          SIMULATOR_IOS_VERSION: ${{ vars.SIMULATOR_IOS_VERSION }}

          # ç•¶å‰ Runner åç¨±
          RUNNER_NAME: ${{ runner.name }}
          
          # æå‡ XCodebuild æŒ‡ä»¤ timeout æ™‚é–“, retry æ¬¡æ•¸
          # å› ç‚ºæ©Ÿå™¨ Loading æ¯”è¼ƒå¤§çš„æ™‚å€™å¯èƒ½ 3 æ¬¡å°±å¤±æ•—äº†
          FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT: 60
          FASTLANE_XCODEBUILD_SETTINGS_RETRIES: 10
        run: |

          # å¦‚æœæ˜¯ self-hosted åœ¨åŒä¸€å°æ©Ÿå™¨èµ·å¤šå€‹ Runner æœƒå‡ºç¾æ¶æ¨¡æ“¬å™¨çš„å•é¡Œ (æ–‡ç« å¾Œæœƒè¬›)
          # è¦é¿å…é€™å•é¡Œå»ºè­°å°‡æ¨¡æ“¬åç¨±å‘½åæˆ Runner åç¨±ï¼Œæ¯å€‹ Runner éƒ½è¨­ä¸€å€‹æ¨¡æ“¬å™¨ï¼Œé€™æ¨£å°±ä¸æœƒäº’æ¶å°è‡´æ¸¬è©¦å¤±æ•—
          # e.g. bundle exec fastlane run_unit_tests device:"${RUNNER_NAME} (${SIMULATOR_IOS_VERSION})"
          # é€™é‚Šæ˜¯ç”¨ GitHub Hosted Runner æ²’é€™å•é¡Œï¼Œæ‰€ä»¥ç›´æ¥ç”¨ device:"${SIMULATOR_NAME} (${SIMULATOR_IOS_VERSION})"

          # ç™¼ç”ŸéŒ¯èª¤ä¸ç›´æ¥é€€å‡ºä¸¦å°‡æ‰€æœ‰è¼¸å‡ºéƒ½å¯«å…¥ temp/testing_output.txt æª”æ¡ˆ
          # å¾ŒçºŒæˆ‘å€‘æœƒåˆ†ææª”æ¡ˆå…§å®¹å€åˆ†å‡ºæ˜¯ Build Failed é‚„æ˜¯ Test Failedï¼ŒComment ä¸åŒè¨Šæ¯åˆ° PR
          set +e
          
          # EXIT_CODE å„²å­˜åŸ·è¡Œçµæœçš„ exit code.
          # 0 = OK
          # 1 = exit
          EXIT_CODE=0
          
          # æ‰€æœ‰è¼¸å‡ºéƒ½å¯«å…¥æª”æ¡ˆ
          bundle exec fastlane ${TEST_LANE} device:"${SIMULATOR_NAME} (${SIMULATOR_IOS_VERSION})" | tee "$RUNNER_TEMP/testing_output.txt"
          # å¦‚æœç›®å‰ EXIT_CODE æ˜¯ 0ï¼Œå‰‡å°‡ ${pipestatus[1]} è³¦å€¼çµ¦ EXIT_CODE
          [[ $EXIT_CODE -eq 0 ]] && EXIT_CODE=${pipestatus[1]}

          # æ¢å¾©å‡ºéŒ¯å°±é€€å‡º
          set -e

          # æª¢æŸ¥ Testing Output
          # å¦‚æœ Testing Output åŒ…å« "Error building"ï¼Œå‰‡è¨­ is_build_error=true çµ¦ Actions ç’°å¢ƒè®Šæ•¸ï¼Œç‚º Build å°±å¤±æ•—
          # å¦‚æœ Testing Output åŒ…å« "Tests have failed"ï¼Œå‰‡è¨­ is_test_error=true çµ¦ Actions ç’°å¢ƒè®Šæ•¸ï¼Œç‚ºæ¸¬è©¦å¤±æ•—
          
          if grep -q "Error building" "$RUNNER_TEMP/testing_output.txt"; then
            echo "is_build_error=true" >> $GITHUB_OUTPUT
            echo "âŒ Detected Build Error"
          elif grep -q "Tests have failed" "$RUNNER_TEMP/testing_output.txt"; then
            echo "is_test_error=true" >> $GITHUB_OUTPUT
            echo "âŒ Detected Test Error"
          fi
          

          # æ¢å¾© Exit Code Output
          exit $EXIT_CODE
          
      # ========== Handle Result Steps ==========
      
      # è§£æ *.junit æ¸¬è©¦å ±å‘Šï¼Œä¸¦æ¨™è¨˜çµæœã€Comment(å¦‚æœæ˜¯ PR çš„è©±)
      - name: Publish Test Report
        # ç›´æ¥å¾©ç”¨åˆ¥äººå¯«å¥½çš„ .junit Paser Actions: https://github.com/mikepenz/action-junit-report
        uses: mikepenz/action-junit-report@v5
        # if:
        # ä¸Šä¸€æ­¥(Testing) success or
        # ä¸Šä¸€æ­¥(Testing) failed and is_test_error (build failed ä¸åŸ·è¡Œé€™å€‹ step)
        if: ${{ (failure() && steps.testing.outputs.is_test_error == 'true') || success() }}
        with:
          check_name: "Testing Report"
          comment: true
          updateComment: false
          require_tests: true
          detailed_summary: true
          report_paths: "./Product/fastlane/test_output/*.junit"

      # æ¸¬è©¦å»ºç½®å¤±æ•— Comment
      - name: Build Failure Comment
        # if:
        # ä¸Šä¸€æ­¥(Testing) failed and is_build_error and æœ‰ PR Number
        # 
        if: ${{ failure() && steps.testing.outputs.is_build_error == 'true' && github.event.pull_request.number }}
        uses: actions/github-script@v6
        env:
          action_url: "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}/attempts/${{ github.run_attempt }}"
        with:
            script: |
              const action_url = process.env.action_url
              const pullRequest = context.payload.pull_request || {}
              const commitSha = pullRequest.head?.sha || context.sha
              const creator = pullRequest.user?.login || context.actor
        
              const commentBody = [
                `# å°ˆæ¡ˆæˆ–æ¸¬è©¦å»ºç½®å¤±æ•— âŒ`,
                `è«‹ç¢ºèªæ‚¨çš„ Pull Request æ˜¯å¦å¯ä»¥æ­£ç¢ºç·¨è­¯èˆ‡åŸ·è¡Œæ¸¬è©¦ã€‚`,
                ``,
                `ğŸ”— **Action**: [View Workflow Run](${action_url})`,
                `ğŸ“ **Commit**: ${commitSha}`,
                `ğŸ‘¤ **Author**: @${creator}`
              ].join('\n')
        
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: commentBody
              })
