# Workflow(Action) åç§°
name: CI-Testing

# Actions æ—¥å¿—çš„æ ‡é¢˜åç§°ï¼ˆPRæ ‡é¢˜æˆ–åˆ†æ”¯åï¼‰
run-name: "[CI-Testing] ${{ github.event.pull_request.title || github.ref }}"

# å¹¶å‘æ§åˆ¶ï¼šåŒç»„ä»»åŠ¡æœ‰æ–°è§¦å‘æ—¶ï¼Œå–æ¶ˆæ­£åœ¨è¿è¡Œçš„æ—§ä»»åŠ¡
# é¿å…å¤šæ¬¡æäº¤å¯¼è‡´çš„èµ„æºæµªè´¹ï¼ˆå¦‚è¿ç»­pushæ—¶ï¼‰
concurrency:
  group: ${{ github.workflow }}-${{ github.event_name }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

# è§¦å‘äº‹ä»¶é…ç½®
on:
  # PRç›¸å…³äº‹ä»¶è§¦å‘
  pull_request:
    # è§¦å‘æ—¶æœºï¼šPRåˆ›å»ºã€é‡æ–°æ‰“å¼€ã€æœ‰æ–°æäº¤æ—¶
    types: [opened, synchronize, reopened]
  # æ‰‹åŠ¨è§¦å‘ï¼ˆå¯é€šè¿‡GitHubç•Œé¢é€‰æ‹©å‚æ•°ï¼‰
  workflow_dispatch:
    inputs:
      # è¦æ‰§è¡Œçš„Fastlaneæµ‹è¯•ä»»åŠ¡
      TEST_LANE:
        description: 'æµ‹è¯•ä»»åŠ¡ï¼ˆFastlane Laneï¼‰'
        default: 'run_unit_tests'
        type: choice
        options:
          - run_unit_tests  # ä»…è¿è¡Œå•å…ƒæµ‹è¯•
          - run_all_tests   # è¿è¡Œæ‰€æœ‰æµ‹è¯•
  # å…è®¸è¢«å…¶ä»–å·¥ä½œæµè°ƒç”¨ï¼ˆå¦‚å¤œé—´æ„å»ºï¼‰
  workflow_call:
    inputs:
      # æµ‹è¯•ä»»åŠ¡ï¼ˆæ— choiceç±»å‹ï¼Œå…¼å®¹workflow_callï¼‰
      TEST_LANE:
        description: 'æµ‹è¯•ä»»åŠ¡ï¼ˆFastlane Laneï¼‰'
        default: 'run_unit_tests'
        type: string
      # è¦æ£€æŸ¥çš„åˆ†æ”¯
      BRANCH:
        description: 'ç›®æ ‡åˆ†æ”¯'
        type: string

# ä»»åŠ¡å®šä¹‰ï¼ˆJobsä¼šå¹¶è¡Œæ‰§è¡Œï¼Œæ­¤å¤„ä»…ä¸€ä¸ªtestingä»»åŠ¡ï¼‰
jobs:
  testing:
    name: æ‰§è¡Œæµ‹è¯•
    # è¿è¡Œç¯å¢ƒï¼šä½¿ç”¨GitHubæ‰˜ç®¡çš„macOS-15 runnerï¼ˆé€‚åˆiOSé¡¹ç›®ï¼‰
    # æ³¨æ„ï¼šå…¬å…±ä»“åº“å¯å…è´¹ä½¿ç”¨ï¼Œç§æœ‰ä»“åº“æŒ‰ç”¨é‡è®¡è´¹ï¼Œå»ºè®®ç§æœ‰é¡¹ç›®ä½¿ç”¨è‡ªæ‰˜ç®¡runner
    runs-on: macos-15
    # è¶…æ—¶æ—¶é—´ï¼šé˜²æ­¢ä»»åŠ¡æ— é™æŒ‚èµ·ï¼ˆæœ€é•¿30åˆ†é’Ÿï¼‰
    timeout-minutes: 30
    # é»˜è®¤ä½¿ç”¨zsh shellï¼ˆæ›¿ä»£é»˜è®¤bashï¼‰
    defaults:
      run:
        shell: zsh {0}

    # æƒé™é…ç½®ï¼šè§£å†³åˆ›å»ºcheck runç­‰æ“ä½œçš„æƒé™é—®é¢˜
    permissions:
      checks: write  # å…è®¸åˆ›å»ºæµ‹è¯•æŠ¥å‘Šcheck run
      pull-requests: write  # å…è®¸å‘PRæäº¤è¯„è®º
      contents: read  # å…è®¸è¯»å–ä»“åº“ä»£ç 

    # æ­¥éª¤å®šä¹‰ï¼ˆæŒ‰é¡ºåºæ‰§è¡Œï¼‰
    steps:
      # 1. æ‹‰å–ä»£ç åˆ°runner
      - name: æ‹‰å–ä»“åº“ä»£ç 
        uses: actions/checkout@v4  # æ›´æ–°åˆ°æœ€æ–°v4ç‰ˆæœ¬
        with:
          lfs: false  # ä¸å¯ç”¨Git LFSï¼ˆé¡¹ç›®æ— éœ€å¤§æ–‡ä»¶æ”¯æŒï¼‰
          #  checkoutæŒ‡å®šåˆ†æ”¯ï¼ˆå¦‚å¤œé—´æ„å»ºéœ€æŒ‡å®šéé»˜è®¤åˆ†æ”¯æ—¶ä½¿ç”¨ï¼‰
          ref: ${{ github.event.inputs.BRANCH || '' }}

      # ========== ç¯å¢ƒé…ç½®æ­¥éª¤ ==========

      # 2. è¯»å–é¡¹ç›®æŒ‡å®šçš„Xcodeç‰ˆæœ¬ï¼ˆä».ruby-versionæ–‡ä»¶ï¼‰
      - name: è¯»å–Xcodeç‰ˆæœ¬
        id: read_xcode_version
        run: |
          # ä»é¡¹ç›®æ ¹ç›®å½•çš„.xcode-versionæ–‡ä»¶è¯»å–ç‰ˆæœ¬å·
          XCODE_VERSION=$(cat .xcode-version)
          echo "æ£€æµ‹åˆ°Xcodeç‰ˆæœ¬: ${XCODE_VERSION}"
          # è¾“å‡ºåˆ°GitHubç¯å¢ƒå˜é‡ï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "xcode_version=${XCODE_VERSION}" >> $GITHUB_OUTPUT

      # 3. è¯»å–é¡¹ç›®æŒ‡å®šçš„Rubyç‰ˆæœ¬ï¼ˆä».ruby-versionæ–‡ä»¶ï¼‰
      - name: è¯»å–Rubyç‰ˆæœ¬
        id: read_ruby_version
        run: |
          # ä»é¡¹ç›®æ ¹ç›®å½•çš„.ruby-versionæ–‡ä»¶è¯»å–ç‰ˆæœ¬å·
          RUBY_VERSION=$(cat .ruby-version)
          echo "æ£€æµ‹åˆ°Rubyç‰ˆæœ¬: ${RUBY_VERSION}"
          # è¾“å‡ºåˆ°GitHubç¯å¢ƒå˜é‡ï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "ruby_version=${RUBY_VERSION}" >> $GITHUB_OUTPUT

      # 4. é…ç½®Rubyç¯å¢ƒï¼ˆå®‰è£…é¡¹ç›®æŒ‡å®šç‰ˆæœ¬ï¼‰
      - name: é…ç½®Rubyç¯å¢ƒ
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "${{ steps.read_ruby_version.outputs.ruby_version }}"  # ä½¿ç”¨è¯»å–åˆ°çš„ç‰ˆæœ¬

      # ========== ç¼“å­˜é…ç½®æ­¥éª¤ï¼ˆåŠ é€Ÿä¾èµ–å®‰è£…ï¼‰ ==========

      # 5. ç¼“å­˜Rubyä¾èµ–ï¼ˆGemfile.lockå¯¹åº”ä¾èµ–ï¼‰
      - name: ç¼“å­˜Rubyä¾èµ–
        uses: actions/cache@v3
        with:
          path: ./vendor  # ç¼“å­˜è·¯å¾„ï¼ˆå¯¹åº”bundle configçš„å®‰è£…ç›®å½•ï¼‰
          # ç¼“å­˜keyï¼šç³»ç»Ÿ+ä¾èµ–é”æ–‡ä»¶å“ˆå¸Œï¼ˆé”æ–‡ä»¶å˜æ›´æ—¶é‡å»ºç¼“å­˜ï¼‰
          key: ${{ runner.os }}-bundle-${{ hashFiles('Gemfile.lock') }}
          # æ¢å¤ç­–ç•¥ï¼šæœªå‘½ä¸­ç²¾ç¡®keyæ—¶ï¼Œä½¿ç”¨æœ€è¿‘çš„æ—§ç¼“å­˜
          restore-keys: |
            ${{ runner.os }}-bundle-

      # 6. ç¼“å­˜CocoaPodsä¾èµ–ï¼ˆPodfile.lockå¯¹åº”ä¾èµ–ï¼‰
      - name: ç¼“å­˜CocoaPodsä¾èµ–
        uses: actions/cache@v3
        with:
          path: ./Product/Pods  # é¡¹ç›®Podsç›®å½•è·¯å¾„
          key: ${{ runner.os }}-cocoapods-${{ hashFiles('Product/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-cocoapods-

      # 7. ç¼“å­˜Mintå·¥å…·ï¼ˆMintfileå®šä¹‰çš„å·¥å…·ï¼‰
      - name: ç¼“å­˜Mintå·¥å…·
        uses: actions/cache@v3
        with:
          path: ./mint  # Mintå®‰è£…è·¯å¾„
          key: ${{ runner.os }}-mint-${{ hashFiles('Mintfile') }}
          restore-keys: |
            ${{ runner.os }}-mint-

      # ========== ä¾èµ–å®‰è£…æ­¥éª¤ ==========

      # 8. é¡¹ç›®åˆå§‹åŒ–ä¸ä¾èµ–å®‰è£…
      - name: åˆå§‹åŒ–é¡¹ç›®å¹¶å®‰è£…ä¾èµ–
        run: |
          # æ‰§è¡ŒMakefileä¸­çš„setupæŒ‡ä»¤ï¼ˆå¦‚å®‰è£…Mintã€Bundleé…ç½®ç­‰ï¼‰
          make setup
          # æ‰§è¡ŒMakefileä¸­çš„installæŒ‡ä»¤ï¼ˆå¦‚ç”ŸæˆXcodeé¡¹ç›®ã€pod installç­‰ï¼‰
          make install

      # ========== æ‰§è¡Œæµ‹è¯•æ­¥éª¤ ==========

      # 9. è¿è¡Œæµ‹è¯•ï¼ˆæ ¸å¿ƒæ­¥éª¤ï¼‰
      - name: æ‰§è¡Œæµ‹è¯•
        id: testing
        working-directory: ./Product/  # åˆ‡æ¢åˆ°Productç›®å½•æ‰§è¡Œ
        env:
          # æµ‹è¯•ä»»åŠ¡é€‰æ‹©ï¼šPRè§¦å‘æ—¶é»˜è®¤ä»…è·‘å•å…ƒæµ‹è¯•ï¼Œå…¶ä»–æƒ…å†µæŒ‰è¾“å…¥å€¼
          TEST_LANE: ${{ github.event_name == 'pull_request' && 'run_unit_tests' || github.event.inputs.TEST_LANE || 'run_all_tests' }}
          # æŒ‡å®šXcodeè·¯å¾„ï¼ˆä½¿ç”¨è¯»å–åˆ°çš„ç‰ˆæœ¬ï¼‰
          DEVELOPER_DIR: "/Applications/Xcode_${{ steps.read_xcode_version.outputs.xcode_version }}.app/Contents/Developer"
          # æ¨¡æ‹Ÿå™¨é…ç½®ï¼ˆä»ä»“åº“å˜é‡è¯»å–ï¼‰
          SIMULATOR_NAME: ${{ vars.SIMULATOR_NAME }}
          SIMULATOR_IOS_VERSION: ${{ vars.SIMULATOR_IOS_VERSION }}
          # å½“å‰runneråç§°
          RUNNER_NAME: ${{ runner.name }}
          # å»¶é•¿Xcodebuildè¶…æ—¶å’Œé‡è¯•æ¬¡æ•°ï¼ˆé¿å…ç¯å¢ƒæ³¢åŠ¨å¯¼è‡´å¤±è´¥ï¼‰
          FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT: 60
          FASTLANE_XCODEBUILD_SETTINGS_RETRIES: 10
        run: |
          # å…³é—­ç«‹å³é€€å‡ºæ¨¡å¼ï¼ˆå³ä½¿å‘½ä»¤å¤±è´¥ä¹Ÿç»§ç»­æ‰§è¡Œåç»­é€»è¾‘ï¼‰
          set +e
          
          EXIT_CODE=0  # å­˜å‚¨å‘½ä»¤é€€å‡ºç ï¼ˆ0=æˆåŠŸï¼Œé0=å¤±è´¥ï¼‰
          # æ‰§è¡ŒFastlaneæµ‹è¯•å‘½ä»¤ï¼Œå¹¶å°†è¾“å‡ºå†™å…¥ä¸´æ—¶æ–‡ä»¶ï¼ˆç”¨äºåç»­åˆ†æï¼‰
          bundle exec fastlane ${TEST_LANE} device:"${SIMULATOR_NAME} (${SIMULATOR_IOS_VERSION})" | tee "$RUNNER_TEMP/testing_output.txt"
          # æ›´æ–°é€€å‡ºç ï¼ˆå–fastlaneå‘½ä»¤çš„å®é™…é€€å‡ºç ï¼‰
          [[ $EXIT_CODE -eq 0 ]] && EXIT_CODE=${pipestatus[1]}
          
          # æ¢å¤ç«‹å³é€€å‡ºæ¨¡å¼
          set -e
          
          # åˆ†æè¾“å‡ºæ–‡ä»¶ï¼Œåˆ¤æ–­å¤±è´¥ç±»å‹ï¼ˆæ„å»ºå¤±è´¥/æµ‹è¯•å¤±è´¥ï¼‰
          if grep -q "Error building" "$RUNNER_TEMP/testing_output.txt"; then
            echo "is_build_error=true" >> $GITHUB_OUTPUT  # æ ‡è®°ä¸ºæ„å»ºå¤±è´¥
            echo "âŒ æ£€æµ‹åˆ°æ„å»ºå¤±è´¥"
          elif grep -q "Tests have failed" "$RUNNER_TEMP/testing_output.txt"; then
            echo "is_test_error=true" >> $GITHUB_OUTPUT  # æ ‡è®°ä¸ºæµ‹è¯•å¤±è´¥
            echo "âŒ æ£€æµ‹åˆ°æµ‹è¯•å¤±è´¥"
          fi
          
          # é€€å‡ºå¹¶è¿”å›å®é™…ç»“æœç 
          exit $EXIT_CODE

      # ========== ç»“æœå¤„ç†æ­¥éª¤ ==========

      # 10. å‘å¸ƒæµ‹è¯•æŠ¥å‘Šï¼ˆç”ŸæˆJUnitæŠ¥å‘Šå¹¶å…³è”åˆ°PRï¼‰
      - name: å‘å¸ƒæµ‹è¯•æŠ¥å‘Š
        # ä»…åœ¨æµ‹è¯•æˆåŠŸæˆ–æµ‹è¯•å¤±è´¥æ—¶æ‰§è¡Œï¼ˆæ„å»ºå¤±è´¥ä¸æ‰§è¡Œï¼‰
        if: ${{ (failure() && steps.testing.outputs.is_test_error == 'true') || success() }}
        uses: mikepenz/action-junit-report@v5
        with:
          check_name: "æµ‹è¯•æŠ¥å‘Š"  # åœ¨PRä¸­æ˜¾ç¤ºçš„æ£€æŸ¥åç§°
          comment: true  # å‘PRæäº¤è¯„è®º
          updateComment: false  # ä¸æ›´æ–°æ—§è¯„è®ºï¼ˆä¿ç•™å†å²ï¼‰
          require_tests: true  # å¿…é¡»æœ‰æµ‹è¯•ç»“æœ
          detailed_summary: true  # æ˜¾ç¤ºè¯¦ç»†æ‘˜è¦
          report_paths: "./Product/fastlane/test_output/*.junit"  # JUnitæŠ¥å‘Šè·¯å¾„

      # 11. æ„å»ºå¤±è´¥æ—¶å‘PRæäº¤è¯„è®º
      - name: æ„å»ºå¤±è´¥è¯„è®º
        # ä»…åœ¨æ„å»ºå¤±è´¥ä¸”å­˜åœ¨PRæ—¶æ‰§è¡Œ
        if: ${{ failure() && steps.testing.outputs.is_build_error == 'true' && github.event.pull_request.number }}
        uses: actions/github-script@v6
        env:
          # å·¥ä½œæµè¿è¡Œåœ°å€ï¼ˆç”¨äºè¯„è®ºä¸­çš„é“¾æ¥ï¼‰
          action_url: "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}/attempts/${{ github.run_attempt }}"
        with:
          script: |
            const action_url = process.env.action_url
            const pullRequest = context.payload.pull_request || {}
            const commitSha = pullRequest.head?.sha || context.sha  # æäº¤SHA
            const creator = pullRequest.user?.login || context.actor  # PRåˆ›å»ºè€…
            
            # è¯„è®ºå†…å®¹
            const commentBody = [
              `# é¡¹ç›®æˆ–æµ‹è¯•æ„å»ºå¤±è´¥ âŒ`,
              `è¯·ç¡®è®¤æ‚¨çš„PRèƒ½å¦æ­£å¸¸ç¼–è¯‘å¹¶æ‰§è¡Œæµ‹è¯•ã€‚`,
              ``,
              `ğŸ”— **å·¥ä½œæµåœ°å€**: [æŸ¥çœ‹è¯¦æƒ…](${action_url})`,
              `ğŸ“ **æäº¤**: ${commitSha}`,
              `ğŸ‘¤ **ä½œè€…**: @${creator}`
            ].join('\n')
            
            # å‘PRæäº¤è¯„è®º
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: commentBody
            })