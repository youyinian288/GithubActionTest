name: Demo-Env-Vars

on:
  workflow_dispatch:

jobs:
  print-env-vars:
    runs-on: ubuntu-latest

    steps:
      - name: print-env
        run: env
      - name: context-vars-vs-vars
        env:
          SAY_MY_NAME: "Heisenberg"
          # GitHub Actions Context è¡¨é”å¼ï¼ŒåŒä¸‹æ–¹è§£é‡‹
          FROM_REF: "${{ github.ref }}"
        run: |
          # Sehll Script:

          # å¼•ç”¨è‡ªè¨‚æ³¨å…¥çš„ ENV è®Šæ•¸å…§å®¹
          # ${SAY_MY_NAME} or $SAY_MY_NAME éƒ½å¯ä»¥
          # ${XX} é‡åˆ°å­—ä¸²æ‹¼æ¥æ¯”è¼ƒå¥½ç”¨:
          echo "HI: ${SAY_MY_NAME}"
          
          # ğŸ’¡ GitHub Actions Context è¡¨é”å¼
          # é€™ä¸æ˜¯ shell è®Šæ•¸ï¼Œè€Œæ˜¯ YAML è§£æéšæ®µç”± GitHub Actions æ›¿æ›æˆå°æ‡‰å€¼
          # âš  åœ¨æœ¬æ©Ÿæˆ–é GitHub Actions ç’°å¢ƒåŸ·è¡Œæœƒå¤±æ•—
          # ğŸ”— https://docs.github.com/en/actions/learn-github-actions/contexts#github-context
          BRANCH_NAME_FROM_CONTEXT="${{ github.ref }}"
          
          # ğŸ’¡ GitHub Actions åŸ·è¡Œéšæ®µçš„ç’°å¢ƒè®Šæ•¸
          # é€™äº›è®Šæ•¸åœ¨ runner åŸ·è¡Œ shell æ™‚ç”± GitHub Actions è‡ªå‹•æ³¨å…¥
          # âœ… åœ¨å…¶ä»–ç’°å¢ƒå¯ç”¨ export æˆ– ENV é å…ˆå®šç¾©ç›¸åŒè®Šæ•¸
          # ğŸ”— https://docs.github.com/en/actions/learn-github-actions/environment-variables
          BRANCH_NAME_FROM_ENV_VARS="${GITHUB_REF}"
          
          echo "FROM_REF: ${FROM_REF}"
          echo "BRANCH_NAME_FROM_CONTEXT: ${BRANCH_NAME_FROM_CONTEXT}"
          echo "BRANCH_NAME_FROM_ENV_VARS: ${BRANCH_NAME_FROM_ENV_VARS}"
      - name: print-github-script-env
        uses: actions/github-script@v7
        env:
          SAY_MY_NAME: "Heisenberg"
          # GitHub Actions Context è¡¨é”å¼ï¼ŒåŒä¸Šæ–¹è§£é‡‹
          FROM_REF: "${{ github.ref }}"
        with:
          script: |
            // GitHub Script: (JavaScript (Node.js)):

            // å¾ process.env å– ENV å€¼
            console.log(`HI: ${process.env.SAY_MY_NAME}`);
            console.log(`FROM_REF: ${process.env.FROM_REF}`);

            // github-script ä¸­æœƒè‡ªå‹•æ³¨å…¥åˆ° context è®Šæ•¸ä¾› javascript ç›´æ¥å¼•ç”¨
            // https://docs.github.com/en/actions/learn-github-actions/contexts#github-context
            const branch_name_from_context_vars = context.ref;
            console.log(`branch_name_from_context_vars: ${branch_name_from_context_vars}`);

            // åŒæ¨£ä¹Ÿèƒ½ç”¨ GitHub Actions Context è¡¨é”å¼(åªæ˜¯æ„ç¾©ä¸å¤§):
            const branch_name_from_context = "${{ github.ref }}";
            console.log(`branch_name_from_context: ${branch_name_from_context}`);
            
            for (const [key, value] of Object.entries(process.env)) {
              console.log(`${key}=${value}`);
            }

            // github-script ä¸­çš„ github ç‰©ä»¶æ˜¯ Octokit REST API å¯¦ä¾‹
            // ç”¨ä¾†æ“ä½œ github api ä½¿ç”¨
            // ä¾‹å¦‚ï¼š
            // await github.rest.pulls.list({
            //   owner: context.repo.owner,
            //   repo: context.repo.repo,
            //   state: "open"
            //  });

      # gh CLI does NOT use GITHUB_TOKEN by default; requires GH_TOKEN
      - name: gh CLI without GH_TOKEN (expected to fail)
        continue-on-error: true
        run: |
          PR_COUNT=$(gh pr list --repo $GITHUB_REPOSITORY --json number --jq 'length')
          echo "Found $PR_COUNT open pull requests"
      
      - name: gh CLI with GH_TOKEN (expected to succeed)
        env:
          # Assign GH_TOKEN so gh CLI can authenticate
          # https://docs.github.com/en/actions/how-tos/security-for-github-actions/security-guides/use-github_token-in-workflows
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_COUNT=$(gh pr list --repo $GITHUB_REPOSITORY --json number --jq 'length')
          echo "Found $PR_COUNT open pull requests"
      
      - name: github-script auto-authentication (no GH_TOKEN needed)
        uses: actions/github-script@v7
        with:
          script: |
            // github = Octokit REST client (auto-authenticated with GITHUB_TOKEN)
            const pulls = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: "open"
            });
            console.log(`Found ${pulls.data.length} open pull requests`);
