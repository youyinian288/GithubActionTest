# Workflow(Action) åç¨±
name: Pull Reqeust Automation

# Actions Log çš„æ¨™é¡Œåç¨±
run-name: "[Pull Reqeust Automation] ${{ github.event.pull_request.title || github.ref }}"

# è§¸ç™¼äº‹ä»¶
on:
  # PR äº‹ä»¶
  pull_request:
    # PR - é–‹å•Ÿã€é‡é–‹ã€æœ‰æ–° Push Commit æ™‚
    types: [opened, synchronize, reopened]

# åŒå€‹ Concurrency Group å¦‚æœæœ‰æ–°çš„ Job æœƒå–æ¶ˆæ­£åœ¨è·‘çš„
# ä¾‹å¦‚ Push Commit è§¸ç™¼çš„ä»»å‹™é‚„æ²’åŸ·è¡Œå°±åˆ Push Commit æ™‚ï¼Œæœƒå–æ¶ˆå‰ä¸€å€‹ä»»å‹™
concurrency:
  group: ${{ github.workflow }}-${{ github.ref_name }}
  cancel-in-progress: true

# Job å·¥ä½œé …ç›®
# Job æœƒä¸¦ç™¼åŸ·è¡Œ
jobs:
  # Job ID
  label-pr-by-file-count:
    # Job åç¨± (å¯çœç•¥ï¼Œæœ‰è¨­å®šåœ¨ Log é¡¯ç¤ºæ¯”è¼ƒå¥½è®€)
    name: Label PR by changes file count

    # å¦‚æœé€™å€‹ Job å¤±æ•—ï¼Œä¸å½±éŸ¿æ•´å€‹ Workflowï¼Œç¹¼çºŒå…¶ä»– Job
    continue-on-error: true
    
    # è¨­å®šæœ€é•· Timeout æ™‚é–“ï¼Œé˜²æ­¢ç•°å¸¸æƒ…æ³ç™¼ç”Ÿæ™‚ç„¡æ­¢ç›¡çš„ç­‰å¾…
    timeout-minutes: 10

    # Runner Label - ä½¿ç”¨ GitHub Hosted Runner ubuntu-latest ä¾†åŸ·è¡Œå·¥ä½œ
    # å¦‚æœæ˜¯ Private Repo æœƒè¨ˆç®—ç”¨é‡ï¼Œè¶…éå¯èƒ½æœƒç”¢ç”Ÿè²»ç”¨
    # ä½†é€™ç¨®è‡ªå‹•åŒ–å°å·¥ä½œä¸å¤ªå®¹æ˜“ç”¨éé‡
    runs-on: ubuntu-latest

    # å·¥ä½œæ­¥é©Ÿ
    # å·¥ä½œæ­¥é©Ÿæœƒç…§é †åºåŸ·è¡Œ
    steps:
      # æ­¥é©Ÿåç¨±
      - name: Get changed file count and apply label
        # æ­¥é©Ÿ ID (å¯çœç•¥ï¼Œå¾ŒçºŒè‹¥æ²’æœ‰ Step è¦å¼•ç”¨ Output è¼¸å‡ºå‰‡ä¸éœ€è¨­å®š)
        id: get-changed-files-count-by-gh
        # æ³¨å…¥å¤–éƒ¨ç’°å¢ƒåƒæ•¸åˆ°åŸ·è¡Œéšæ®µ
        env:
          # secrets.GITHUB_TOKEN æ˜¯ GitHub Actions åŸ·è¡Œæ™‚è‡ªå‹•ç”¢ç”Ÿçš„ Tokenï¼Œä¸éœ€è‡ªè¡Œåœ¨ Secrets è¨­å®šï¼Œæ“æœ‰ä¸€äº› GitHub Repo API Scopes æ¬Šé™
          # https://docs.github.com/en/actions/how-tos/security-for-github-actions/security-guides/use-github_token-in-workflows
          # gh(GitHub) cli éœ€è¦æ³¨å…¥ GH_TOKEN åˆ° ENVï¼Œgh æ‰æœ‰æ¬Šé™æ“ä½œ 
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        # Shell script
        # GitHub Hosted Runner å…§å»ºéƒ½æœ‰å®‰è£å¥½ gh cliï¼Œä¸éœ€è¦å®‰è£ Job å°±èƒ½ç›´æ¥ä½¿ç”¨
        run: |
          #   ${{ github.xxx }} æ˜¯ GitHub Actions Context è¡¨é”å¼
          #   ä¸æ˜¯ Shell è®Šæ•¸ï¼Œè€Œæ˜¯ YAML è§£æéšæ®µç”± GitHub Actions æ›¿æ›æˆå°æ‡‰å€¼
          #   å…¶ä»–åƒæ•¸ï¼šhttps://docs.github.com/en/actions/learn-github-actions/contexts#github-context
          
          # å–å¾— PR ç·¨è™Ÿ:
          PR_NUMBER=${{ github.event.pull_request.number }}

          # å–å¾— Repo:
          REPO=${{ github.repository }}

          # ä½¿ç”¨ GitHub API (gh cli) å–å¾— File changed æ•¸é‡
          FILE_COUNT=$(gh pr view $PR_NUMBER --repo $REPO --json files --jq '.files | length')
          
          # Print Log
          echo "Changed file count: $FILE_COUNT"

          # Label é‚è¼¯
          if [ "$FILE_COUNT" -lt 5 ]; then
            LABEL="XS"
          elif [ "$FILE_COUNT" -lt 10 ]; then
            LABEL="S"
          elif [ "$FILE_COUNT" -lt 30 ]; then
            LABEL="M"
          elif [ "$FILE_COUNT" -lt 80 ]; then
            LABEL="L"
          elif [ "$FILE_COUNT" -lt 200 ]; then
            LABEL="XL"
          else
            LABEL="XXL"
          fi

          # ä½¿ç”¨ GitHub API (gh cli) ç§»é™¤ç›®å‰çš„ Size Label
          EXISTING_LABELS=$(gh pr view "$PR_NUMBER" --repo "$REPO" --json labels --jq '.labels[].name')
          for EXISTING in $EXISTING_LABELS; do
            case "$EXISTING" in
              XS|S|M|L|XL|XXL)
                echo "ğŸ§¹ Removing existing label: $EXISTING"
                gh pr edit "$PR_NUMBER" --repo "$REPO" --remove-label "$EXISTING"
                ;;
            esac
          done

          # (å¯é¸)å¦‚æœ Label ä¸å­˜åœ¨å‰‡å»ºç«‹
          if ! gh label list --repo "$REPO" | grep -q "^$LABEL"; then
            echo "ğŸ†• Creating missing label: $LABEL"
            gh label create "$LABEL" --repo "$REPO" --description "Size label: $LABEL" --color "ededed"
          else
            echo "âœ… Label '$LABEL' already exists"
          fi
          
          # ä½¿ç”¨ GitHub API (gh cli) æ¨™è¨˜ä¸Š Label
          gh pr edit $PR_NUMBER --repo $REPO --add-label "$LABEL"
  # ---------
  assign-self-if-no-assignee:
    name: Automatically assign to self if no assignee is specified
    # å› ç‚ºæ˜¯å…±ç”¨è§¸ç™¼äº‹ä»¶ï¼Œæ‰€ä»¥åœ¨ Job ä¸Šè‡ªå·±åˆ¤æ–·ï¼Œç•¶æ˜¯ Pull Request Opened(é¦–æ¬¡å»ºç«‹) æ™‚æ‰åŸ·è¡Œ Job å¦å‰‡æœƒ Skipped
    if: github.event_name == 'pull_request' && github.event.action == 'opened'

    # å¦‚æœé€™å€‹ Job å¤±æ•—ï¼Œä¸å½±éŸ¿æ•´å€‹ Workflowï¼Œç¹¼çºŒå…¶ä»– Job
    continue-on-error: true
    
    # è¨­å®šæœ€é•· Timeout æ™‚é–“ï¼Œé˜²æ­¢ç•°å¸¸æƒ…æ³ç™¼ç”Ÿæ™‚ç„¡æ­¢ç›¡çš„ç­‰å¾…
    timeout-minutes: 10
    
    # Runner Label - ä½¿ç”¨ GitHub Hosted Runner ubuntu-latest ä¾†åŸ·è¡Œå·¥ä½œ
    # å¦‚æœæ˜¯ Private Repo æœƒè¨ˆç®—ç”¨é‡ï¼Œè¶…éå¯èƒ½æœƒç”¢ç”Ÿè²»ç”¨
    # ä½†é€™ç¨®è‡ªå‹•åŒ–å°å·¥ä½œä¸å¤ªå®¹æ˜“ç”¨éé‡
    runs-on: ubuntu-latest

    steps:
      - name: Assign self if No Assignee
        # ä½¿ç”¨ GitHub Script (JavaScript) æ’°å¯«è…³æœ¬ (Node.js ç’°å¢ƒ)
        # ç›¸è¼ƒä¸Šé¢ç›´æ¥ç”¨ Shell Script å¯«èµ·ä¾†æ›´æ–¹ä¾¿æ¼‚äº®
        # ä¹Ÿä¸éœ€è¦è‡ªè¡Œæ³¨å…¥ç’°å¢ƒè®Šæ•¸ã€GITHUB_TOKEN
        uses: actions/github-script@v7
        with:
          script: |
            // github-script ä¸­æœƒè‡ªå‹•æ³¨å…¥åˆ° context è®Šæ•¸ä¾› javascript ç›´æ¥å¼•ç”¨
            // https://docs.github.com/en/actions/learn-github-actions/contexts#github-context
            
            const issue = context.payload.pull_request; // å¦‚æœè¦é€£ Issue ä¸€èµ·æ”¯æ´å¯å¯«æˆ context.payload.issue || context.payload.pull_request
            const assignees = issue.assignees || [];
            const me = context.actor;

            if (assignees.length === 0) {
              // github-script ä¸­çš„ github ç‰©ä»¶æ˜¯ Octokit REST API å¯¦ä¾‹
              // ç”¨ä¾†æ“ä½œ github api ä½¿ç”¨
              
              // Assignee è¨­æˆè‡ªå·±
              await github.rest.issues.addAssignees({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                assignees: [me]
              });

              // ç•™è¨€é€šçŸ¥
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `ğŸ”§ No assignee was set, so I have assigned this to myself (@${me}).`
              });
            }
  # ---------
  append-author-to-pr-description:
    name: Append author to PR description
    # å› ç‚ºæ˜¯å…±ç”¨è§¸ç™¼äº‹ä»¶ï¼Œæ‰€ä»¥åœ¨ Job ä¸Šè‡ªå·±åˆ¤æ–·ï¼Œç•¶æ˜¯ Pull Request Opened(é¦–æ¬¡å»ºç«‹) æ™‚æ‰åŸ·è¡Œ Job å¦å‰‡æœƒ Skipped
    if: github.event_name == 'pull_request' && github.event.action == 'opened'
    
    # å¦‚æœé€™å€‹ Job å¤±æ•—ï¼Œä¸å½±éŸ¿æ•´å€‹ Workflowï¼Œç¹¼çºŒå…¶ä»– Job
    continue-on-error: true
    
    # è¨­å®šæœ€é•· Timeout æ™‚é–“ï¼Œé˜²æ­¢ç•°å¸¸æƒ…æ³ç™¼ç”Ÿæ™‚ç„¡æ­¢ç›¡çš„ç­‰å¾…
    timeout-minutes: 10
    
    # Runner Label - ä½¿ç”¨ GitHub Hosted Runner ubuntu-latest ä¾†åŸ·è¡Œå·¥ä½œ
    # å¦‚æœæ˜¯ Private Repo æœƒè¨ˆç®—ç”¨é‡ï¼Œè¶…éå¯èƒ½æœƒç”¢ç”Ÿè²»ç”¨
    # ä½†é€™ç¨®è‡ªå‹•åŒ–å°å·¥ä½œä¸å¤ªå®¹æ˜“ç”¨éé‡
    runs-on: ubuntu-latest
    steps:
      - name: Append author to PR description
        env:
          # secrets.GITHUB_TOKEN æ˜¯ GitHub Actions åŸ·è¡Œæ™‚è‡ªå‹•ç”¢ç”Ÿçš„ Tokenï¼Œä¸éœ€è‡ªè¡Œåœ¨ Secrets è¨­å®šï¼Œæ“æœ‰ä¸€äº› GitHub Repo API Scopes æ¬Šé™
          # gh(GitHub) cli éœ€è¦æ³¨å…¥ GH_TOKEN åˆ° ENVï¼Œgh æ‰æœ‰æ¬Šé™æ“ä½œ
          # https://docs.github.com/en/actions/how-tos/security-for-github-actions/security-guides/use-github_token-in-workflows
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

          #   ${{ github.xxx }} æ˜¯ GitHub Actions Context è¡¨é”å¼
          #   ä¸æ˜¯ Shell è®Šæ•¸ï¼Œè€Œæ˜¯ YAML è§£æéšæ®µç”± GitHub Actions æ›¿æ›æˆå°æ‡‰å€¼
          #   å…¶ä»–åƒæ•¸ï¼šhttps://docs.github.com/en/actions/learn-github-actions/contexts#github-context
          PR_NUMBER: ${{ github.event.pull_request.number }}
          AUTHOR_TAG: '@${{ github.event.pull_request.user.login }}'
        run: |
          PR_BODY=$(gh pr view $PR_NUMBER --repo ${{ github.repository }} --json body -q ".body")
          NEW_BODY=$(printf "%s\n\nCreated by %s" "$PR_BODY" "$AUTHOR_TAG")
          gh pr edit $PR_NUMBER --repo ${{ github.repository }} --body "$NEW_BODY"
