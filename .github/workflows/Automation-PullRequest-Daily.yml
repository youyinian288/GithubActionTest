# Workflow(Action) åç¨±
name: Pull Reqeust Automation - Daily Checker

# Actions Log çš„æ¨™é¡Œåç¨±
run-name: "Pull Reqeust Automation - Daily Checker"

# è§¸ç™¼äº‹ä»¶
on:
  # æ’ç¨‹å®šæ™‚è‡ªå‹•åŸ·è¡Œ
  # https://crontab.guru/
  # UTC æ™‚é–“
  schedule:
    # UTC çš„ 01:00 = æ¯å¤© UTC+8 çš„ 09:00
    - cron: '0 1 * * *'
  # æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:

# Job å·¥ä½œé …ç›®
# Job æœƒä¸¦ç™¼åŸ·è¡Œ
jobs:
  # Job ID
  caculate-pr-status:
    # Job åç¨± (å¯çœç•¥ï¼Œæœ‰è¨­å®šåœ¨ Log é¡¯ç¤ºæ¯”è¼ƒå¥½è®€)
    name: Caculate PR Status
    # Runner Label - ä½¿ç”¨ GitHub Hosted Runner ubuntu-latest ä¾†åŸ·è¡Œå·¥ä½œ
    # å¦‚æœæ˜¯ Private Repo æœƒè¨ˆç®—ç”¨é‡ï¼Œè¶…éå¯èƒ½æœƒç”¢ç”Ÿè²»ç”¨
    runs-on: ubuntu-latest

    # Job Output
    outputs:
      pr_list: ${{ steps.pr-info.outputs.pr_list }}

    # å·¥ä½œæ­¥é©Ÿ
    # å·¥ä½œæ­¥é©Ÿæœƒç…§é †åºåŸ·è¡Œ
    steps:
      # æ­¥é©Ÿåç¨±
      - name: Fetch open PRs and caculate
        # Step å¤–éƒ¨è¦å¼•ç”¨ Output è¼¸å‡ºï¼Œéœ€è¨­å®š
        id: pr-info
        uses: actions/github-script@v7
        with:
          script: |
            const now = new Date();
            const per_page = 100;
            let page = 1;
            let allPRs = [];
      
            while (true) {
              const { data: prs } = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                per_page,
                page,
              });
              if (prs.length === 0) break;
              allPRs = allPRs.concat(prs);
              if (prs.length < per_page) break;
              page++;
            }
      
            const result = allPRs.map(pr => {
              const created = new Date(pr.created_at);
              const daysOpen = Math.floor((now - created) / (1000 * 60 * 60 * 24));
              return {
                pr: pr.number.toString(),
                title: pr.title,
                idle: daysOpen
              };
            });

            // è¨­å®šå› Outputï¼Œåªæ¥å— String
            core.setOutput('pr_list', JSON.stringify(result));
  # ----
  send-pr-summary-message-to-slack:
    name: Send PR Summary Messag to Slack
    # Job é è¨­æ˜¯ä¸¦ç™¼ï¼Œä½¿ç”¨ needs å¯ä»¥è¿«ä½¿ç•¶å‰ Job ç­‰åˆ° need Job å®Œæˆæ™‚æ‰æœƒåŸ·è¡Œ
    needs: [caculate-pr-status]
    runs-on: ubuntu-latest
    
    steps:
      - name: Generate Message
        # Step å¤–éƒ¨è¦å¼•ç”¨ Output è¼¸å‡ºï¼Œéœ€è¨­å®š
        id: gen-msg
        uses: actions/github-script@v7
        with:
          script: |
            const prList = JSON.parse(`${{ needs.caculate-pr-status.outputs.pr_list }}`);
            const blocks = [];
      
            // æ¨™é¡Œ
            blocks.push({
              type: "section",
              text: {
                type: "mrkdwn",
                text: `ğŸ“¬ *Open PR Report*\nTotal: *${prList.length}* PR(s)`
              }
            });
      
            // æ¯å€‹ PR ä¸€è¡Œ
            for (const pr of prList) {
              blocks.push({
                type: "section",
                text: {
                  type: "mrkdwn",
                  text: `â€¢ <https://github.com/${context.repo.owner}/${context.repo.repo}/pull/${pr.pr}|PR #${pr.pr}> *${pr.title}* - ğŸ•’ ${pr.idle} day(s)`
                }
              });
            }

            // è¨­å®šå› Outputï¼Œåªæ¥å— String
            core.setOutput('blocks', JSON.stringify(blocks));

            
      # ä½¿ç”¨ Slack å®˜æ–¹å°è£å¥½çš„ Slack API Github Actions
      # https://tools.slack.dev/slack-github-action/sending-techniques/sending-data-slack-api-method/
      # ç™¼é€è¨Šæ¯
      - name: Post text to a Slack channel
        uses: slackapi/slack-github-action@v2.1.0
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            channel: ${{ vars.SLACK_TEAM_CHANNEL_ID }}
            blocks: ${{ steps.gen-msg.outputs.blocks }}
  # ----
  auto-close-old-prs:
    name: Auto Close Old PRs
    needs: [caculate-pr-status]
    runs-on: ubuntu-latest

    steps:
      - name: Auto close PRs opened more than 90 days
        uses: actions/github-script@v7
        with:
          script: |
            const prList = JSON.parse(`${{ needs.caculate-pr-status.outputs.pr_list }}`);
            const oldPRs = prList.filter(pr => pr.idle > 90);

            for (const pr of oldPRs) {
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: parseInt(pr.pr),
                state: 'closed'
              });

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: parseInt(pr.pr),
                body: `âš ï¸ This pull request has been automatically closed because it has been open for more than 90 days. Please reopen if needed.`
              });
            }

            console.log(`Closed ${oldPRs.length} PR(s)`);
